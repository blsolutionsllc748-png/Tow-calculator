<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Transport Cost Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --brand-bg:#0b0f14;
      --brand-card:#ffffff;
      --brand-text:#111827;
      --brand-muted:#6b7280;
      --brand-accent:#c1121f;
      --brand-accent-2:#0b1220;
      --brand-success:#16a34a;
      --brand-blue:#2563eb;
      --border:#e5e7eb;
    }

    body{font-family:Arial,sans-serif;background:#f3f4f6;margin:0;padding:0;}
    .container{max-width:820px;margin:40px auto;background:var(--brand-card);border-radius:14px;padding:24px;box-shadow:0 10px 25px rgba(0,0,0,.08);border:1px solid var(--border);}

    .header{display:flex;align-items:center;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:6px;}
    .logo{height:42px;width:auto;display:block;}
    h1{text-align:center;margin:0;font-size:24px;color:var(--brand-text);}
    .subtitle{text-align:center;font-size:14px;color:var(--brand-muted);margin:8px 0 18px;}
    label{font-weight:bold;font-size:14px;display:block;margin-top:12px;margin-bottom:6px;color:var(--brand-text);}

    input[type="text"], select{
      width:100%;padding:10px 10px;border-radius:10px;border:1px solid var(--border);
      font-size:14px;box-sizing:border-box;background:#fff;
    }

    .row{display:flex;gap:12px;flex-wrap:wrap;}
    .col{flex:1;min-width:240px;}

    .checkbox-row{display:flex;align-items:center;margin-top:12px;font-size:14px;color:var(--brand-text);}
    .checkbox-row input{margin-right:8px;transform:scale(1.05);}

    button{
      width:100%;margin-top:18px;padding:12px 0;background:var(--brand-accent-2);color:#fff;
      font-size:16px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;
    }
    button:hover{opacity:.92;}

    #result{margin-top:16px;font-size:15px;min-height:44px;color:var(--brand-text);}
    .meta{margin-top:10px;font-size:13px;color:var(--brand-muted);min-height:18px;white-space:pre-wrap;word-break:break-word;}

    .badge{
      display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;
      background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;margin-left:6px;
    }

    .disclaimer{margin-top:16px;font-size:12px;color:var(--brand-muted);line-height:1.45;}
    .cta{display:none;margin-top:14px;gap:10px;display:flex;flex-wrap:wrap;}
    .cta a{
      flex:1;min-width:160px;text-align:center;padding:11px 12px;color:#fff;
      text-decoration:none;border-radius:12px;font-weight:bold;
    }
    .cta .call{background:var(--brand-success);}
    .cta .sms{background:var(--brand-accent-2);}
    .cta .email{background:var(--brand-blue);}

    .muted{opacity:.55;}
    .hint{font-size:12px;color:var(--brand-muted);margin-top:6px;}
    .hr{height:1px;background:var(--border);margin:18px 0 6px;}
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <img class="logo" src="logo.png" alt="B-L Auto Export" onerror="this.style.display='none';" />
      <h1>Transport Cost Calculator <span class="badge">Broker estimate</span></h1>
    </div>

    <div class="subtitle">
      Local towing + nationwide auction/port transport. Final pricing confirmed before dispatch.
    </div>

    <div class="row">
      <div class="col">
        <label for="serviceType">Service type</label>
        <select id="serviceType">
          <option value="local">Local Tow (short distance)</option>
          <option value="transport" selected>Auction / Port Transport (nationwide)</option>
        </select>
        <div class="hint">Tip: Use “Transport” for auction → yard/port, long distance, Central Dispatch jobs.</div>
      </div>

      <div class="col">
        <label for="vehicleType">Vehicle type</label>
        <select id="vehicleType">
          <option value="sedan">Sedan/Compact</option>
          <option value="suv">SUV/Crossover</option>
          <option value="pickup">Pickup Truck</option>
          <option value="van">Van</option>
          <option value="oversize">Oversize/Heavy (manual quote)</option>
        </select>
        <div class="hint">Vehicle type affects estimate (larger vehicles cost more).</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="shippingType">Shipping type</label>
        <select id="shippingType">
          <option value="open" selected>Open carrier</option>
          <option value="enclosed">Enclosed carrier</option>
        </select>
        <div class="hint">Enclosed is priced higher than open.</div>
      </div>

      <div class="col">
        <label>&nbsp;</label>
        <div class="checkbox-row" id="portRow" style="margin-top:0;">
          <input id="portExport" type="checkbox" />
          <span>Port / Export handling (+$75)</span>
        </div>
        <div class="hint">Port/Export add-on applies to transport jobs.</div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="vin">VIN (optional)</label>
        <input id="vin" type="text" placeholder="17-character VIN" maxlength="17" />
        <div id="vinInfo" class="meta"></div>
      </div>

      <div class="col">
        <label>&nbsp;</label>
        <div class="checkbox-row" style="margin-top:0;">
          <input id="nonRunner" type="checkbox" />
          <span>Vehicle is a non-runner</span>
        </div>
        <div class="hint">Non-runner may require extra loading effort.</div>
      </div>
    </div>

    <div class="hr"></div>

    <label for="pickup">Pickup address</label>
    <input id="pickup" type="text" placeholder="e.g. Copart / IAAI address" />

    <label for="dropoff">Drop-off address</label>
    <input id="dropoff" type="text" placeholder="e.g. Shipping yard / Port (RoRo)" />

    <button id="calcBtn">Calculate Estimate</button>

    <div id="result"></div>

    <div id="cta" class="cta">
      <a class="call" href="tel:5083692955">Call Now</a>
      <a id="smsBtn" class="sms" href="sms:5083692955">Request Tow (Text)</a>
      <a id="emailBtn" class="email" href="mailto:info@blautoexport.com">Request Tow (Email)</a>
    </div>

    <div class="disclaimer">
      This is a non-binding estimate. Final price may vary based on carrier availability, vehicle condition, timing, access/wait time,
      and port requirements. We’ll confirm a final quote before dispatch.
    </div>
  </div>

  <script>
    // =========================================================
    // 1) INSERT YOUR RESTRICTED ROUTES API KEY HERE (Routes API only)
    //    - Application restriction: Websites (HTTP referrers)
    //    - Allowed referrers: https://blautoexport.com/* and/or github pages
    //    - API restriction: Routes API
    // =========================================================
    const GOOGLE_API_KEY = "AIzaSyBY26KUbAP6pSgGb3BBAVP15xjr_6EqFig";

    // =========================================================
    // 2) BUSINESS SETTINGS (you can tweak anytime)
    // =========================================================

    // Local Tow pricing
    const LOCAL_FLAT_UP_TO_10MI = 125;      // flat rate for <= 10 miles
    const LOCAL_PER_MILE_AFTER_10 = 4.50;   // per mile after 10
    const LOCAL_NONRUNNER = 50;

    // Transport pricing
    const TRANS_MINIMUM = 200;
    const TRANS_PER_MILE = 1.50;
    const TRANS_NONRUNNER = 125;

    // Add-ons
    const PORT_EXPORT_FEE = 75;

    // Broker fee + lane surcharge + rounding (helps hit clean numbers like ~$300)
    const TRANS_BROKER_FEE = 70;            // added AFTER multipliers
    const ROUND_TO = 25;                    // rounds to nearest $25
    const ROUNDING_MODE = "nearest";        // "nearest" | "up"

    // Vehicle multipliers
    const VEHICLE_MULTIPLIERS = {
      sedan: 1.00,
      suv: 1.15,
      pickup: 1.25,
      van: 1.20
    };

    // Shipping multipliers
    const SHIPPING_MULTIPLIERS = {
      open: 1.00,
      enclosed: 1.60
    };

    // Optional lane surcharge rules (simple, adjustable)
    const LANE_SURCHARGES = [
      { name: "Northeast congestion", match: /\b(NY|NJ|PA|MA|CT|MD|RI|NH|VT|ME)\b/i, fee: 50 },
      { name: "Port lane premium", match: /(port|terminal|roro|ro-ro|seaport)/i, fee: 75 }
    ];

    // Admin-only breakdown: add ?admin=1 to the URL
    const IS_ADMIN = new URLSearchParams(window.location.search).get("admin") === "1";

    // =========================================================
    // 3) HELPERS
    // =========================================================
    function money(n) { return "$" + Number(n).toFixed(2); }
    function shippingLabel(s) { return (s === "enclosed") ? "Enclosed" : "Open"; }
    function vehicleLabel(v) {
      return ({
        sedan: "Sedan/Compact",
        suv: "SUV/Crossover",
        pickup: "Pickup Truck",
        van: "Van",
        oversize: "Oversize/Heavy (manual quote)"
      })[v] || v;
    }

    function cleanAddress(addr) {
      return (addr || "")
        .replace(/contact info.*$/i, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function roundPrice(amount) {
      if (!isFinite(amount)) return amount;
      if (ROUNDING_MODE === "up") return Math.ceil(amount / ROUND_TO) * ROUND_TO;
      return Math.round(amount / ROUND_TO) * ROUND_TO;
    }

    function calculateLaneSurcharge(origin, destination) {
      let surcharge = 0;
      for (const lane of LANE_SURCHARGES) {
        if (lane.match.test(origin) || lane.match.test(destination)) surcharge += lane.fee;
      }
      return surcharge;
    }

    // =========================================================
    // 4) ROUTES API (works with browser referrer-restricted keys)
    // =========================================================
    async function getDrivingDistanceMeters(origin, destination) {
      const res = await fetch("https://routes.googleapis.com/directions/v2:computeRoutes", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Goog-Api-Key": GOOGLE_API_KEY,
          "X-Goog-FieldMask": "routes.distanceMeters"
        },
        body: JSON.stringify({
          origin: { address: origin },
          destination: { address: destination },
          travelMode: "DRIVE"
        })
      });

      const text = await res.text();
      if (!res.ok) {
        // show full Google error text (useful if something is still wrong)
        throw new Error(`Routes API failed (${res.status}): ${text}`);
      }

      const data = JSON.parse(text);
      const meters = data?.routes?.[0]?.distanceMeters;
      if (!meters) throw new Error("No route distance returned.");
      return meters;
    }

    // =========================================================
    // 5) VIN VALIDATION + DECODE (NHTSA VPIC - no Google key needed)
    // =========================================================
    function normalizeVin(vin) { return (vin || "").trim().toUpperCase(); }
    function isValidVinFormat(vin) { return /^[A-HJ-NPR-Z0-9]{17}$/.test(vin); }

    async function decodeVinNHTSA(vin) {
      const url = "https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVin/" + encodeURIComponent(vin) + "?format=json";
      const res = await fetch(url);
      if (!res.ok) throw new Error("VIN decode failed");
      const data = await res.json();

      const map = {};
      for (const item of (data.Results || [])) {
        if (item.Variable && item.Value) map[item.Variable] = item.Value;
      }

      const year = (map["Model Year"] || "").trim();
      const make = (map["Make"] || "").trim();
      const model = (map["Model"] || "").trim();
      const bodyClass = (map["Body Class"] || "").trim();
      const vehicleType = (map["Vehicle Type"] || "").trim();

      return {
        year, make, model, bodyClass, vehicleType,
        display: (year + " " + make + " " + model).trim()
      };
    }

    function suggestVehicleTypeFromVin(decoded) {
      const blob = ((decoded.bodyClass || "") + " " + (decoded.vehicleType || "")).toLowerCase();
      if (blob.includes("pickup")) return "pickup";
      if (blob.includes("van")) return "van";
      if (blob.includes("sport utility") || blob.includes("suv") || blob.includes("multipurpose")) return "suv";
      return "sedan";
    }

    // =========================================================
    // 6) UI LOGIC
    // =========================================================
    window.addEventListener("load", function () {
      const btn = document.getElementById("calcBtn");

      const serviceTypeEl = document.getElementById("serviceType");
      const vehicleTypeEl = document.getElementById("vehicleType");
      const shippingTypeEl = document.getElementById("shippingType");

      const vinEl = document.getElementById("vin");
      const vinInfoEl = document.getElementById("vinInfo");

      const pickupInput = document.getElementById("pickup");
      const dropoffInput = document.getElementById("dropoff");

      const nonRunnerEl = document.getElementById("nonRunner");
      const portExportEl = document.getElementById("portExport");
      const portRow = document.getElementById("portRow");

      const resultDiv = document.getElementById("result");
      const cta = document.getElementById("cta");
      const smsBtn = document.getElementById("smsBtn");
      const emailBtn = document.getElementById("emailBtn");

      function syncPortRow() {
        const isTransport = serviceTypeEl.value === "transport";
        portRow.classList.toggle("muted", !isTransport);
        portExportEl.disabled = !isTransport;
        if (!isTransport) portExportEl.checked = false;
      }
      serviceTypeEl.addEventListener("change", syncPortRow);
      syncPortRow();

      btn.addEventListener("click", async function () {
        const serviceType = serviceTypeEl.value;     // local | transport
        const shippingType = shippingTypeEl.value;   // open | enclosed

        const isNonRunner = nonRunnerEl.checked;
        const isPortExport = (serviceType === "transport") && portExportEl.checked;

        cta.style.display = "none";
        vinInfoEl.textContent = "";

        const origin = cleanAddress(pickupInput.value);
        const destination = cleanAddress(dropoffInput.value);

        if (!origin || !destination) {
          resultDiv.style.color = "red";
          resultDiv.textContent = "Please enter both pickup and drop-off addresses.";
          return;
        }

        if (vehicleTypeEl.value === "oversize") {
          resultDiv.style.color = "red";
          resultDiv.textContent = "Oversize/Heavy vehicles require a manual quote. Please call or text.";
          cta.style.display = "flex";
          return;
        }

        // VIN decode (optional) + auto-suggest vehicle type
        const vin = normalizeVin(vinEl.value);
        let vinDecoded = "";

        if (vin) {
          if (!isValidVinFormat(vin)) {
            resultDiv.style.color = "red";
            resultDiv.textContent = "VIN looks invalid (must be 17 chars; no I/O/Q). Please check and try again.";
            return;
          }
          vinInfoEl.textContent = "Decoding VIN...";
          try {
            const vinMeta = await decodeVinNHTSA(vin);
            vinDecoded = vinMeta.display || "";
            vinInfoEl.textContent = vinDecoded ? ("VIN decoded: " + vinDecoded) : "VIN decoded (details unavailable).";

            const suggested = suggestVehicleTypeFromVin(vinMeta);
            vehicleTypeEl.value = suggested;
          } catch (e) {
            vinInfoEl.textContent = "VIN decode failed (still calculating estimate).";
          }
        }

        resultDiv.style.color = "#111827";
        resultDiv.textContent = "Calculating distance and estimate...";

        try {
          const meters = await getDrivingDistanceMeters(origin, destination);
          const miles = meters / 1609.34;

          const vehicleType = vehicleTypeEl.value;
          const vMult = VEHICLE_MULTIPLIERS[vehicleType] || 1.0;
          const sMult = SHIPPING_MULTIPLIERS[shippingType] || 1.0;

          let total = 0;
          let admin = { miles, vMult, sMult, base: 0, broker: 0, lane: 0, roundedFrom: 0 };

          if (serviceType === "local") {
            // 10-mile flat rate
            const baseLocal = (miles <= 10)
              ? LOCAL_FLAT_UP_TO_10MI
              : (LOCAL_FLAT_UP_TO_10MI + ((miles - 10) * LOCAL_PER_MILE_AFTER_10));

            total = baseLocal + (isNonRunner ? LOCAL_NONRUNNER : 0);
            total = total * vMult;

            admin.base = baseLocal;
          } else {
            // Transport
            const mileageCost = miles * TRANS_PER_MILE;

            const baseTransport =
              Math.max(TRANS_MINIMUM, mileageCost) +
              (isNonRunner ? TRANS_NONRUNNER : 0) +
              (isPortExport ? PORT_EXPORT_FEE : 0);

            total = baseTransport * vMult * sMult;
            admin.base = baseTransport;

            // Broker fee (after multipliers)
            total += TRANS_BROKER_FEE;
            admin.broker = TRANS_BROKER_FEE;

            // Lane surcharge
            const lane = calculateLaneSurcharge(origin, destination);
            total += lane;
            admin.lane = lane;
          }

          admin.roundedFrom = total;
          total = roundPrice(total);

          const serviceLabel = (serviceType === "local") ? "Local Tow" : "Auction/Port Transport";
          const distanceLine = miles.toFixed(1) + " miles";
          const vehicleText = vehicleLabel(vehicleType);
          const shipText = shippingLabel(shippingType);
          const estimateText = money(total);

          // CUSTOMER-FACING OUTPUT (NO formula/breakdown)
          resultDiv.style.color = "#111827";
          resultDiv.innerHTML =
            "<strong>Estimated cost: " + estimateText + "</strong><br>" +
            "Distance: " + distanceLine + "<br>" +
            "Service: " + serviceLabel + "<br>" +
            "Vehicle type: " + vehicleText + "<br>" +
            "Shipping: " + shipText + "<br>" +
            (vin ? ("VIN: " + vin + "<br>") : "") +
            (vinDecoded ? ("VIN decoded: " + vinDecoded + "<br>") : "");

          // ADMIN-ONLY DEBUG (visit page with ?admin=1)
          if (IS_ADMIN) {
            resultDiv.innerHTML +=
              "<hr style='margin:10px 0;border:none;border-top:1px solid #e5e7eb;'>" +
              "<strong>Admin breakdown</strong><br>" +
              "Miles: " + admin.miles.toFixed(1) + "<br>" +
              "Base: " + money(admin.base) + "<br>" +
              "Vehicle mult: x" + admin.vMult.toFixed(2) + "<br>" +
              "Shipping mult: x" + admin.sMult.toFixed(2) + "<br>" +
              (serviceType === "transport" ? ("Broker fee: " + money(admin.broker) + "<br>") : "") +
              (serviceType === "transport" ? ("Lane surcharge: " + money(admin.lane) + "<br>") : "") +
              "Rounded from: " + money(admin.roundedFrom) + " → " + money(total);
          }

          cta.style.display = "flex";

          // Fill SMS + Email
          const nonRunnerText = isNonRunner ? "Yes" : "No";
          const portText = (serviceType === "transport" && isPortExport) ? "Yes (+$75)" : "No";

          smsBtn.href =
            "sms:5083692955?&body=" +
            encodeURIComponent(
              "Hi B-L Auto Export, I'd like a quote/booking.\n" +
              "Service: " + serviceLabel + "\n" +
              "Vehicle type: " + vehicleText + "\n" +
              "Shipping: " + shipText + "\n" +
              (vin ? ("VIN: " + vin + "\n") : "") +
              (vinDecoded ? ("VIN decoded: " + vinDecoded + "\n") : "") +
              "Pickup: " + origin + "\n" +
              "Drop-off: " + destination + "\n" +
              "Distance: " + distanceLine + "\n" +
              "Non-runner: " + nonRunnerText + "\n" +
              "Port/Export: " + portText + "\n" +
              "Estimated cost: " + estimateText
            );

          emailBtn.href =
            "mailto:info@blautoexport.com?subject=" +
            encodeURIComponent("Tow/Transport Request - B-L Auto Export") +
            "&body=" +
            encodeURIComponent(
              "Hello,\n\nI want to request a quote/booking.\n\n" +
              "Service: " + serviceLabel + "\n" +
              "Vehicle type: " + vehicleText + "\n" +
              "Shipping: " + shipText + "\n" +
              (vin ? ("VIN: " + vin + "\n") : "") +
              (vinDecoded ? ("VIN decoded: " + vinDecoded + "\n") : "") +
              "Pickup: " + origin + "\n" +
              "Drop-off: " + destination + "\n" +
              "Distance: " + distanceLine + "\n" +
              "Non-runner: " + nonRunnerText + "\n" +
              "Port/Export: " + portText + "\n" +
              "Estimated cost: " + estimateText + "\n\n" +
              "Thanks"
            );

        } catch (err) {
          resultDiv.style.color = "red";
          resultDiv.textContent =
            "Unable to calculate distance. Please verify addresses and try again. (" + err.message + ")";
        }
      });
    });
  </script>
</body>
</html>
